[gcode_macro SET_MATERIAL]
description: Set values based on material type and nozzle size (with MPC + PA table)
variable_material: ''
variable_adaptive_mesh: False
gcode:
    {% set MATERIAL = params.MATERIAL|default('PLA')|string %}
    {% set OFFSET = params.OFFSET|default(0)|float %}
    {% set NOZZLE_raw = params.NOZZLE if 'NOZZLE' in params else (printer.configfile.config.extruder.nozzle_diameter|default('0.4')) %}
    {% set NOZZLE = (NOZZLE_raw | replace('mm','') | float) %}

    # Store selected material
    SET_GCODE_VARIABLE MACRO=SET_MATERIAL VARIABLE=material VALUE='"{MATERIAL}"'

    ################################################################################
    # Pressure advance lookup: (material, nozzle) -> PA value
    ################################################################################
    {% set pa_table = {
        "PLA":  {"0.4": 0.035, "0.6": 0.030, "0.8": 0.028},
        "PETG": {"0.4": 0.03525,"0.6": 0.031, "0.8": 0.029},
        "ABS":  {"0.4": 0.028,  "0.6": 0.025, "0.8": 0.023},
        "ASA":  {"0.4": 0.028,  "0.6": 0.025, "0.8": 0.023}
    } %}
    {% set PA_VAL = pa_table.get(MATERIAL, {}).get(NOZZLE|string, 0.035) %}

    M117 PA={PA_VAL} | {MATERIAL} | {NOZZLE}mm
    SET_PRESSURE_ADVANCE ADVANCE={PA_VAL}

    ################################################################################
    # Filament density & heat capacity (g/cm³ , J/g/K) for MPC
    ################################################################################
    {% set filament_table = {
        "PLA":    (1.25, 2.20),
        "PETG":   (1.27, 2.20),
        "ABS":    (1.06, 2.40),
        "ASA":    (1.07, 2.10),
        "PC":     (1.20, 1.90),
        "TPU":    (1.21, 2.00),
        "PLA-CF": (1.29, 2.20)
    } %}
    {% set props = filament_table.get(MATERIAL, (1.25, 2.20)) %}
    {% set density = props[0] %}
    {% set heat_capacity = props[1] %}

    M117 {MATERIAL} | ρ={density} g/cm³ | Cp={heat_capacity} J/g/K

    ################################################################################
    # Load saved mesh only if adaptive mesh wasn't run this session
    ################################################################################
    {% if not printer.set_material.adaptive_mesh %}
        {% if MATERIAL == 'PLA' %}
            BED_MESH_PROFILE LOAD="default"
        {% elif MATERIAL in ['ABS','ASA'] %}
            BED_MESH_PROFILE LOAD="abs"
        {% elif MATERIAL == 'PETG' %}
            BED_MESH_PROFILE LOAD="petg"
        {% else %}
            BED_MESH_PROFILE LOAD="default"
        {% endif %}
    {% endif %}

    ################################################################################
    # Material-specific offsets & fan profiles
    ################################################################################
    {% if MATERIAL == 'PLA' %}
        SET_GCODE_OFFSET Z_ADJUST=0
        SET_FAN_SPEED FAN=nevermore SPEED=0

    {% elif MATERIAL in ['ABS','ASA'] %}
        SET_GCODE_OFFSET Z_ADJUST=0
        SET_FAN_SPEED FAN=nevermore SPEED=1.0

    {% elif MATERIAL == 'PETG' %}
        SET_GCODE_OFFSET Z_ADJUST=0.055
        SET_FAN_SPEED FAN=nevermore SPEED=0.5

    {% else %}
        SET_GCODE_OFFSET Z_ADJUST=0
        SET_FAN_SPEED FAN=nevermore SPEED=0
    {% endif %}

    ################################################################################
    # Push filament properties into MPC
    ################################################################################
    MPC_SET HEATER=extruder FILAMENT_DENSITY={density} FILAMENT_HEAT_CAPACITY={heat_capacity}

    ################################################################################
    # Expose values as macro variables
    ################################################################################
    SET_GCODE_VARIABLE MACRO=SET_MATERIAL VARIABLE=density VALUE={density}
    SET_GCODE_VARIABLE MACRO=SET_MATERIAL VARIABLE=heat_capacity VALUE={heat_capacity}
    SET_GCODE_VARIABLE MACRO=SET_MATERIAL VARIABLE=pa VALUE={PA_VAL}
